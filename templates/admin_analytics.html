<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAATRAM - AI & Selection Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #1e5799 0%, #2989d8 50%, #207cca 100%);
            padding: 20px 0;
            text-align: center;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header-title {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .nav-back {
            display: inline-block;
            padding: 10px 20px;
            background: #2196F3;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* Top Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .stat-card.blue {
            border-left: 5px solid #2196F3;
        }

        .stat-card.green {
            border-left: 5px solid #4CAF50;
        }

        .stat-card.red {
            border-left: 5px solid #f44336;
        }

        .stat-content h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .stat-content .value {
            font-size: 36px;
            font-weight: 700;
        }

        .stat-card.blue .value {
            color: #2196F3;
        }

        .stat-card.green .value {
            color: #4CAF50;
        }

        .stat-card.red .value {
            color: #f44336;
        }

        .stat-icon {
            font-size: 48px;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-container.large {
            height: 400px;
        }

        /* Batch Filter */
        .batch-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .batch-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }

        .batch-btn.active {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }

        .batch-btn:hover {
            border-color: #2196F3;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="header-title">MAATRAM - AI & SELECTION DASHBOARD</div>
    </div>

    <div class="container">
        <a href="/admin/assign" class="nav-back">‚Üê Back to Admin Panel</a>

        <!-- Top Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card blue">
                <div class="stat-content">
                    <h3>üìã Total Applications</h3>
                    <div class="value" id="stat-total">-</div>
                </div>
                <div class="stat-icon">üìä</div>
            </div>
            <div class="stat-card green">
                <div class="stat-content">
                    <h3>‚úÖ Total Selected</h3>
                    <div class="value" id="stat-selected">-</div>
                </div>
                <div class="stat-icon">‚úì</div>
            </div>
            <div class="stat-card red">
                <div class="stat-content">
                    <h3>‚ùå Total Rejected</h3>
                    <div class="value" id="stat-rejected">-</div>
                </div>
                <div class="stat-icon">‚úó</div>
            </div>
        </div>

        <!-- AI Accuracy - Full Width -->
        <div class="charts-grid">
            <div class="chart-card full-width">
                <div class="chart-title">AI vs Manual Decision Accuracy</div>
                <div class="chart-container large">
                    <canvas id="accuracyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 2: Three Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">Prediction Errors Breakdown</div>
                <div class="chart-container">
                    <canvas id="errorsBreakdownChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">AI Error Type Analysis</div>
                <div class="chart-container">
                    <canvas id="errorTypesChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Selected Students by Gender</div>
                <div class="chart-container">
                    <canvas id="selectedChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 3: Rejected & Trends -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">Rejected Students by Gender</div>
                <div class="chart-container">
                    <canvas id="rejectedChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Gender-Wise Selection by Stream</div>
                <div class="chart-container">
                    <canvas id="streamGenderChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Total Maatram Strength Over Years</div>
                <div class="chart-container">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadDashboard() {
            try {
                // Fetch all data
                const [overview, accuracy, errors, selectedGender, rejectedGender, deptStats, trends] = await Promise.all([
                    fetch('/api/analytics/overview').then(r => r.json()),
                    fetch('/api/analytics/ai-accuracy').then(r => r.json()),
                    fetch('/api/analytics/ai-errors').then(r => r.json()),
                    fetch('/api/analytics/gender-distribution').then(r => r.json()),
                    fetch('/api/analytics/rejected-distribution').then(r => r.json()),
                    fetch('/api/analytics/department-stats').then(r => r.json()),
                    fetch('/api/analytics/yearly-trends').then(r => r.json())
                ]);

                // Update stat cards
                document.getElementById('stat-total').textContent = overview.total || 0;
                document.getElementById('stat-selected').textContent = overview.selected || 0;
                document.getElementById('stat-rejected').textContent = overview.rejected || 0;

                // 1. AI Accuracy Donut Chart (Large, Centered)
                new Chart(document.getElementById('accuracyChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Correct Predictions', 'Wrong Predictions'],
                        datasets: [{
                            data: [accuracy.correct || 0, accuracy.wrong || 0],
                            backgroundColor: ['#4CAF50', '#f44336'],
                            borderWidth: 3,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { font: { size: 16 } }
                            },
                            title: {
                                display: true,
                                text: `AI Accuracy: ${accuracy.accuracy_percent || 0}%`,
                                font: { size: 24, weight: 'bold' },
                                color: '#4CAF50',
                                padding: 20
                            }
                        }
                    }
                });

                // 2. Prediction Errors Breakdown (Pie)
                new Chart(document.getElementById('errorsBreakdownChart'), {
                    type: 'pie',
                    data: {
                        labels: ['AI Selected (Wrong)', 'AI Rejected (Wrong)'],
                        datasets: [{
                            data: [errors.false_positives || 0, errors.false_negatives || 0],
                            backgroundColor: ['#ff9800', '#2196F3'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });

                // 3. AI Error Types (Bar)
                new Chart(document.getElementById('errorTypesChart'), {
                    type: 'bar',
                    data: {
                        labels: ['Wrong Select', 'Wrong Reject'],
                        datasets: [{
                            label: 'Error Count',
                            data: [errors.false_positives || 0, errors.false_negatives || 0],
                            backgroundColor: ['#ff9800', '#2196F3']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });

                // 4. Selected Students by Gender (Pie Chart)
                const selectedTotal = (selectedGender.male || 0) + (selectedGender.female || 0);
                new Chart(document.getElementById('selectedChart'), {
                    type: 'pie',
                    data: {
                        labels: ['Male', 'Female'],
                        datasets: [{
                            data: [selectedGender.male || 0, selectedGender.female || 0],
                            backgroundColor: ['#2196F3', '#E91E63'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: {
                                display: true,
                                text: `Total Selected: ${selectedTotal}`,
                                font: { size: 18, weight: 'bold' },
                                color: '#4CAF50'
                            }
                        }
                    }
                });

                // 5. Rejected Students by Gender (Pie Chart)
                const rejectedTotal = (rejectedGender.male || 0) + (rejectedGender.female || 0);

                new Chart(document.getElementById('rejectedChart'), {
                    type: 'pie',
                    data: {
                        labels: ['Male', 'Female'],
                        datasets: [{
                            data: [rejectedGender.male || 0, rejectedGender.female || 0],
                            backgroundColor: ['#f44336', '#FF6B9D'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: {
                                display: true,
                                text: `Total Rejected: ${rejectedTotal}`,
                                font: { size: 18, weight: 'bold' },
                                color: '#f44336'
                            }
                        }
                    }
                });

                // 6. Stream Gender Chart (Stacked)
                const deptLabels = Object.keys(deptStats);
                const maleData = deptLabels.map(d => deptStats[d].male || 0);
                const femaleData = deptLabels.map(d => deptStats[d].female || 0);

                new Chart(document.getElementById('streamGenderChart'), {
                    type: 'bar',
                    data: {
                        labels: deptLabels,
                        datasets: [
                            {
                                label: 'Male',
                                data: maleData,
                                backgroundColor: '#2196F3'
                            },
                            {
                                label: 'Female',
                                data: femaleData,
                                backgroundColor: '#E91E63'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: { x: { stacked: true }, y: { beginAtZero: true } }
                    }
                });

                // 7. Yearly Trends (Area Chart)
                const years = Object.keys(trends).sort();
                const streams = [...new Set(years.flatMap(y => Object.keys(trends[y])))];

                const datasets = streams.map((stream, i) => ({
                    label: stream,
                    data: years.map(y => trends[y][stream] || 0),
                    fill: true,
                    backgroundColor: `rgba(${i * 80}, ${150 - i * 30}, ${200 - i * 50}, 0.3)`,
                    borderColor: `rgb(${i * 80}, ${150 - i * 30}, ${200 - i * 50})`,
                    tension: 0.4
                }));

                new Chart(document.getElementById('trendsChart'), {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: { y: { beginAtZero: true } }
                    }
                });

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>

</html>