<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PV Volunteer - Physical Verification Form</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: #eef0f4;
      color: #333;
    }

    /* ===== Minimized Header ===== */
    .header {
      background: white;
      padding: 8px 0;
      text-align: center;
      border-bottom: 1px solid #ddd;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .logo-img {
      height: 45px;
      margin-bottom: 4px;
    }

    .header-title {
      font-size: 15px;
      font-weight: 700;
      color: #ff9800;
    }

    /* ===== Container ===== */
    .container {
      width: 95%;
      max-width: 1180px;
      margin: 20px auto;
      padding: 25px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
    }

    .student-info {
      text-align: center;
      background: #fff3e0;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #333;
      font-weight: 600;
    }

    .section {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      font-size: 14px;
      color: #555;
      margin-bottom: 8px;
    }

    textarea,
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: 0.3s;
    }

    textarea {
      min-height: 80px;
    }

    textarea:focus,
    select:focus {
      border-color: #ff9800;
      outline: none;
      box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
    }

    /* Buttons */
    .recording-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .record-btn,
    .stop-btn {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      color: white;
    }

    .record-btn {
      background: #4caf50;
    }

    .stop-btn {
      background: #f44336;
    }

    /* Audio */
    audio {
      width: 100%;
      margin-top: 15px;
      display: none;
    }

    audio:not([style*="display: none"]) {
      display: block;
    }

    .upload-box {
      width: 100%;
      padding: 10px;
      border: 2px dashed #ddd;
      border-radius: 6px;
    }

    .submit-btn {
      width: 100%;
      padding: 15px;
      border-radius: 8px;
      border: none;
      color: white;
      font-size: 16px;
      font-weight: bold;
      background: #ff9800;
      margin-top: 30px;
      cursor: pointer;
    }

    /* Image Upload UI */
    .img-upload-container {
      margin-top: 15px;
      background: white;
      border: 1px dashed #bbb;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }

    /* Upload Summary */
    .upload-summary {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin: 15px 0;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 6px;
    }

    .count-badge {
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 13px;
      font-weight: bold;
      color: white;
    }

    .count-badge.green {
      background: #4CAF50;
    }

    .count-badge.red {
      background: #f44336;
    }

    .img-preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 15px;
    }

    .img-preview-card {
      border: 3px solid #ddd;
      border-radius: 8px;
      padding: 8px;
      background: white;
      position: relative;
      transition: all 0.3s;
    }

    .img-preview-card.accepted {
      border-color: #4CAF50;
      background: #f1f8f4;
    }

    .img-preview-card.rejected {
      border-color: #f44336;
      background: #fef1f0;
    }

    .img-preview-card.uploading {
      border-color: #2196F3;
      background: #e3f2fd;
    }

    .img-preview-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 4px;
    }

    .img-preview-card.rejected img {
      opacity: 0.5;
      filter: grayscale(50%);
    }

    /* Status Badge */
    .status-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
      color: white;
      z-index: 5;
    }

    .status-badge.green {
      background: #4CAF50;
    }

    .status-badge.red {
      background: #f44336;
    }

    .status-badge.blue {
      background: #2196F3;
    }

    /* Image Info */
    .image-info {
      margin-top: 8px;
      text-align: left;
    }

    .image-name {
      font-size: 12px;
      font-weight: 500;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .rejection-reason {
      font-size: 11px;
      color: #f44336;
      margin-top: 4px;
      line-height: 1.3;
    }

    /* Retry Button */
    .retry-btn {
      width: 100%;
      margin-top: 6px;
      padding: 6px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      font-weight: bold;
    }

    .retry-btn:hover {
      background: #1976D2;
    }

    /* Loading Spinner */
    .spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #2196F3;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin: 5px auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .img-delete-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 20px;
      height: 20px;
      background: rgba(244, 67, 54, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      line-height: 18px;
      text-align: center;
      padding: 0;
      transition: all 0.2s;
      z-index: 10;
    }

    .img-delete-btn:hover {
      background: rgba(244, 67, 54, 1);
      transform: scale(1.1);
    }

    .check-quality-btn {
      background: #FF9800;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      opacity: 0.6;
      pointer-events: none;
    }

    .check-quality-btn.active {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>

<body>

  <div class="header">
    <img src="/static/logo_icon.jpg" class="logo-img">
    <div class="header-title">Physical Verification Form</div>
  </div>

  <div class="container">
    <p class="student-info"><b>Student ID:</b> {{ studentId }}</p>

    <!-- BASIC FIELDS -->
    <div class="section">
      <label>Property Type</label>
      <textarea id="propertyType" placeholder="House / Rental / Orphanage / Hostel"></textarea>
    </div>

    <div class="section">
      <label>What You Saw</label>
      <textarea id="whatYouSaw" placeholder="Describe what you observed."></textarea>
    </div>

    <!-- MAIN COMMENTS TEXTAREA (MATCHING WORKING VERSION) -->

    <!-- 8 EXTRA COMMENT BOXES -->
    <div class="section">
      <h2 style="font-size:18px; margin-bottom:10px;">ðŸ§¾ PV Volunteer Additional Comments</h2>

      <div class="comments">

        <div>
          <div class="comment-label">Family Background <span class="required">*</span></div>
          <textarea id="c_family"
            placeholder="Eg: Write about your family members â€” their jobs, income, and education. Mention how your family manages monthly expenses and whether anyone supports your education."
            required></textarea>
        </div>

        <div>
          <div class="comment-label">Household Verification <span class="required">*</span></div>
          <textarea id="c_household"
            placeholder="Eg: Describe your home. Is it owned or rented? Mention roof type, number of rooms, and items like furniture, TV, fridge, or vehicle. Note if items are new or old, and if bought fully or on EMI."
            required></textarea>
        </div>

        <div>
          <div class="comment-label">Financial Observation <span class="required">*</span></div>
          <textarea id="c_financial"
            placeholder="Eg: Give details about your familyâ€™s total income and monthly expenses. Mention any savings, support from relatives or government schemes, and how your family manages financially."
            required></textarea>
        </div>

        <div>
          <div class="comment-label">Loan / EMI Details <span class="required">*</span></div>
          <textarea id="c_loan"
            placeholder="Eg: Enter details of any existing loans. Include the loan purpose (education, house, vehicle, etc.), EMI amount, remaining balance, and whether it affects your financial stability."
            required></textarea>
        </div>

        <div>
          <div class="comment-label">Application for Education Loan <span class="required">*</span></div>
          <textarea id="c_edu_loan"
            placeholder="Eg: State whether you are aware of education loans, if you are eligible, and whether you have applied. If not, mention if you need help or guidance to apply for one."
            required></textarea>
        </div>

        <div>
          <div class="comment-label">Student Attitude / Behavior <span class="required">*</span></div>
          <textarea id="c_attitude"
            placeholder="Eg: Describe about the student's willingness to study, ability to live away from home if needed, sense of responsibility, and communication skills."
            required></textarea>
        </div>

        <div>
          <div class="comment-label">Other Observations (Scenario-Based) <span class="required">*</span></div>
          <textarea id="c_observation"
            placeholder="Eg: Mention any special or sensitive situations such as single-parent families, orphaned students, health issues, or other conditions needing additional support."
            required></textarea>
        </div>

        <div>
          <div class="comment-label">If not selected by Maatram â€” What next? <span class="required">*</span></div>
          <textarea id="c_backup"
            placeholder="Eg: Explain your backup plan if the Maatram Scholarship is not approved. For example, applying for another NGO or government scholarship, taking an education loan, or working part-time."
            required></textarea>
        </div>

      </div>
    </div>


    <div class="section">
      <label>Recommendation</label>
      <select id="volunteerRecommendation">
        <option disabled selected>-- Select Recommendation --</option>
        <option value="SELECT">Select</option>
        <option value="ON HOLD">On Hold</option>
        <option value="REJECT">Reject</option>
      </select>
    </div>

    <!-- HOUSE IMAGES UPLOAD -->
    <div class="section">
      <label>House Images (Min 2)</label>
      <div class="img-upload-container">
        <p style="font-size:13px; color:#666; margin-bottom:10px;">Select multiple images</p>

        <input type="file" id="houseImgInput" accept="image/*" capture="environment" multiple
          style="display:block; margin:0 auto;">

        <div id="imgStatus" style="font-size:12px; margin-top:5px; height:15px;"></div>

        <!-- Upload Summary -->
        <div id="uploadSummary" class="upload-summary" style="display: none;">
          <span id="acceptedCount" class="count-badge green">0 Accepted</span>
          <span id="rejectedCount" class="count-badge red">0 Rejected</span>
        </div>

        <div class="img-preview-grid" id="previewGrid">
          <!-- Thumbnails will appear here -->
        </div>

        <div style="margin-top: 10px;">
          <button type="button" class="check-quality-btn" id="checkQualityBtn">Check Quality</button>
          <button type="button" class="check-quality-btn" id="finalUploadBtn" style="background: #2196F3; margin-left: 10px;">Upload</button>
        </div>
      </div>
    </div>

    <!-- RECORD AUDIO -->
    <div class="section">
      <label>Record Voice Comment</label>
      <div class="recording-controls">
        <button class="record-btn" id="startRecordBtn">Start Recording</button>
        <button class="stop-btn" id="stopRecordBtn" disabled>Stop</button>
      </div>
      <audio id="audioPlayback" controls></audio>
    </div>

    <!-- UPLOAD AUDIO -->
    <div class="section">
      <label>OR Upload Audio File</label>
      <input type="file" id="audioFile" accept="audio/*" class="upload-box">
      <audio id="uploadedAudio" controls style="display:none;"></audio>
    </div>

    <button class="submit-btn" id="submitBtn" type="button">Submit</button>
  </div>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    let audioBase64 = "";
    let uploadedCount = 0;
    let imagesUploaded = false; // Track if final upload was done
    const MIN_IMAGES = 1; // Matches backend configuration

    /* Start Recording */
    document.getElementById("startRecordBtn").onclick = async () => {
      let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.start();
      document.getElementById("startRecordBtn").disabled = true;
      document.getElementById("stopRecordBtn").disabled = false;
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    };

    /* Stop Recording */
    document.getElementById("stopRecordBtn").onclick = () => {
      mediaRecorder.stop();
      document.getElementById("stopRecordBtn").disabled = true;
      document.getElementById("startRecordBtn").disabled = false;

      mediaRecorder.onstop = () => {
        let blob = new Blob(audioChunks, { type: "audio/webm" });
        let url = URL.createObjectURL(blob);
        let player = document.getElementById("audioPlayback");
        player.src = url;
        player.style.display = "block";

        let reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = () => audioBase64 = reader.result;
      };
    };

    /* Upload Audio */
    document.getElementById("audioFile").onchange = function () {
      let file = this.files[0];
      if (!file) return;

      let reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => {
        audioBase64 = reader.result;
        let url = URL.createObjectURL(file);
        let player = document.getElementById("uploadedAudio");
        player.src = url;
        player.style.display = "block";
        document.getElementById("audioPlayback").style.display = "none";
      };
    };

    /* --- BATCH IMAGE QUALITY CHECK (1 API CALL FOR ALL IMAGES) --- */

    let selectedFiles = [];
    let acceptedImages = [];
    let rejectedImages = [];
    let qualityChecked = false;

    // 1. Handle file selection (No API call yet)
    document.getElementById("houseImgInput").onchange = function () {
      const files = Array.from(this.files);
      if (files.length === 0) return;

      // Add new files to selected list
      files.forEach(file => {
        // Check if file already exists
        const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
        if (!exists) {
          selectedFiles.push(file);
          createPreviewCard(file);
        }
      });

      // Update UI
      updateButtons();

      // Reset input
      this.value = "";
    };

    function createPreviewCard(file) {
      const grid = document.getElementById('previewGrid');
      const url = URL.createObjectURL(file);
      const cardId = `img-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

      const card = document.createElement('div');
      card.id = cardId;
      card.className = 'img-preview-card';
      card.dataset.filename = file.name;

      card.innerHTML = `
        <img src="${url}">
        <button class="img-delete-btn" onclick="removePreview('${cardId}', '${file.name}')" title="Remove">Ã—</button>
        <div class="image-info">
          <div class="image-name">${file.name}</div>
        </div>
      `;

      grid.appendChild(card);
    }

    function removePreview(cardId, filename) {
      // Remove from selectedFiles
      selectedFiles = selectedFiles.filter(f => f.name !== filename);

      // Remove from accepted/rejected if quality was checked
      acceptedImages = acceptedImages.filter(img => img.name !== filename);
      rejectedImages = rejectedImages.filter(img => img.name !== filename);

      // Remove card
      const card = document.getElementById(cardId);
      if (card) card.remove();

      // Update UI
      updateButtons();
      updateSummary();

      // Reset flags if no files left
      if (selectedFiles.length === 0) {
        qualityChecked = false;
        uploadedCount = 0;
        imagesUploaded = false;
      }
    }

    // 2. Check Quality Button (1 API call for all images)
    document.getElementById("checkQualityBtn").onclick = async function () {
      if (selectedFiles.length < MIN_IMAGES) {
        alert(`Please select at least ${MIN_IMAGES} images first.`);
        return;
      }

      const btn = this;
      btn.innerText = "Checking Quality...";
      btn.disabled = true;

      // Show uploading state on all cards
      selectedFiles.forEach(file => {
        const card = document.querySelector(`[data-filename="${file.name}"]`);
        if (card) {
          card.className = 'img-preview-card uploading';
          const badge = document.createElement('div');
          badge.className = 'status-badge blue';
          badge.textContent = 'â³ Checking...';
          card.appendChild(badge);

          const info = card.querySelector('.image-info');
          const spinner = document.createElement('div');
          spinner.className = 'spinner';
          info.appendChild(spinner);
        }
      });

      try {
        // Create FormData with all images
        const formData = new FormData();
        formData.append("studentId", "{{ studentId }}");
        selectedFiles.forEach((file, index) => {
          formData.append(`images`, file);
        });

        // Single API call for all images
        const res = await fetch("/batch-quality-check", {
          method: "POST",
          body: formData
        });

        const data = await res.json();

        if (res.ok && data.results) {
          // Process results for each image
          acceptedImages = [];
          rejectedImages = [];

          data.results.forEach(result => {
            const card = document.querySelector(`[data-filename="${result.filename}"]`);
            if (!card) return;

            if (result.status === 'GOOD') {
              updateCardStatusBatch(card, 'accepted', 'âœ… Accepted', null, result.filename);
              acceptedImages.push({
                name: result.filename,
                file: selectedFiles.find(f => f.name === result.filename)
              });
            } else {
              updateCardStatusBatch(card, 'rejected', 'âŒ Rejected', result.reason, result.filename);
              rejectedImages.push({
                name: result.filename,
                reason: result.reason
              });
            }
          });

          qualityChecked = true;
          uploadedCount = acceptedImages.length;

          updateSummary();
          updateButtons();

          btn.innerText = "âœ“ Quality Checked";
          btn.style.background = "#4CAF50";
        } else {
          alert("Error checking image quality: " + (data.error || "Unknown error"));
          btn.innerText = "Check Quality";
          btn.disabled = false;
        }

      } catch (err) {
        console.error(err);
        alert("Error checking image quality");
        btn.innerText = "Check Quality";
        btn.disabled = false;
      }
    };

    function updateCardStatusBatch(card, status, badgeText, reason, filename) {
      // Update card class
      card.className = `img-preview-card ${status}`;

      // Remove old badge and spinner
      const oldBadge = card.querySelector('.status-badge');
      if (oldBadge) oldBadge.remove();
      const spinner = card.querySelector('.spinner');
      if (spinner) spinner.remove();

      // Add new badge
      const badge = document.createElement('div');
      badge.className = `status-badge ${status === 'accepted' ? 'green' : 'red'}`;
      badge.textContent = badgeText;
      card.appendChild(badge);

      const info = card.querySelector('.image-info');

      // Add rejection reason if rejected
      if (status === 'rejected' && reason) {
        const reasonDiv = document.createElement('div');
        reasonDiv.className = 'rejection-reason';
        reasonDiv.textContent = reason;
        info.appendChild(reasonDiv);

        // Add retry button
        const retryBtn = document.createElement('button');
        retryBtn.className = 'retry-btn';
        retryBtn.textContent = 'ðŸ”„ Select Another';
        retryBtn.onclick = () => {
          document.getElementById('houseImgInput').click();
        };
        info.appendChild(retryBtn);
      }
    }

    function updateButtons() {
      const checkBtn = document.getElementById('checkQualityBtn');

      // Check Quality button
      if (selectedFiles.length >= MIN_IMAGES && !qualityChecked) {
        checkBtn.classList.add('active');
        checkBtn.disabled = false;
        checkBtn.innerText = 'Check Quality';
      } else {
        checkBtn.classList.remove('active');
        checkBtn.disabled = true;
        checkBtn.innerText = qualityChecked ? 'âœ“ Quality Checked' : 'Select images first';
      }
    }

    function updateCardStatus(cardId, status, badgeText, reason, filename) {
      const card = document.getElementById(cardId);
      if (!card) return;

      // Update card class
      card.className = `img-preview-card ${status}`;

      // Update badge
      const badge = card.querySelector('.status-badge');
      badge.className = `status-badge ${status === 'accepted' ? 'green' : 'red'}`;
      badge.textContent = badgeText;

      // Update info section
      const info = card.querySelector('.image-info');

      // Remove spinner
      const spinner = info.querySelector('.spinner');
      if (spinner) spinner.remove();

      // Update filename
      const nameEl = info.querySelector('.image-name');
      if (nameEl) nameEl.textContent = filename;

      // Add rejection reason if rejected
      if (status === 'rejected' && reason) {
        const reasonDiv = document.createElement('div');
        reasonDiv.className = 'rejection-reason';
        reasonDiv.textContent = reason;
        info.appendChild(reasonDiv);

        // Add retry button
        const retryBtn = document.createElement('button');
        retryBtn.className = 'retry-btn';
        retryBtn.textContent = 'ðŸ”„ Try Another';
        retryBtn.onclick = () => {
          document.getElementById('houseImgInput').click();
        };
        info.appendChild(retryBtn);
      }

      // Add delete button for accepted images
      if (status === 'accepted') {
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'img-delete-btn';
        deleteBtn.textContent = 'Ã—';
        deleteBtn.title = 'Remove image';
        deleteBtn.onclick = function () {
          deleteAcceptedImage(card, filename);
        };
        card.appendChild(deleteBtn);
      }
    }

    function updateSummary() {
      const summary = document.getElementById('uploadSummary');
      const acceptedCount = document.getElementById('acceptedCount');
      const rejectedCount = document.getElementById('rejectedCount');

      acceptedCount.textContent = `${acceptedImages.length} Accepted`;
      rejectedCount.textContent = `${rejectedImages.length} Rejected`;

      if (acceptedImages.length > 0 || rejectedImages.length > 0) {
        summary.style.display = 'flex';
      }
    }

    function deleteAcceptedImage(card, filename) {
      if (!confirm('Remove this image?')) return;

      // Remove from accepted list
      acceptedImages = acceptedImages.filter(img => img.name !== filename);

      // Remove card
      card.remove();

      // Decrement count
      uploadedCount = Math.max(0, uploadedCount - 1);

      // Update UI
      checkFinalButton();
      updateSummary();

      // Reset upload flag if count drops below minimum
      if (uploadedCount < MIN_IMAGES) {
        imagesUploaded = false;
      }

      // Update status
      let statusEl = document.getElementById("imgStatus");
      statusEl.innerText = "Image removed. Upload more if needed.";
      statusEl.style.color = "orange";
    }

    function checkFinalButton() {
      let btn = document.getElementById("finalUploadBtn");
      if (uploadedCount >= MIN_IMAGES) {
        btn.classList.add("active");
        btn.innerText = `Upload`;
      } else {
        btn.classList.remove("active");
        btn.innerText = `Scan/Upload to enable`;
      }
    }

    // 3. Handle Final Upload (Upload accepted images to server)
    document.getElementById("finalUploadBtn").onclick = async function () {
      if (!qualityChecked || acceptedImages.length < MIN_IMAGES) {
        alert("Please check quality first and ensure you have accepted images.");
        return;
      }

      let btn = this;
      btn.innerText = "Uploading...";
      btn.disabled = true;
      btn.classList.remove("active");

      try {
        // Create FormData with accepted images
        const formData = new FormData();
        formData.append("studentId", "{{ studentId }}");

        acceptedImages.forEach(img => {
          formData.append("images", img.file);
        });

        let res = await fetch("/final-upload-batch", {
          method: "POST",
          body: formData
        });
        let data = await res.json();

        if (data.success) {
          alert("Images uploaded and analyzed successfully!");
          btn.innerText = "âœ“ Done";
          btn.style.background = "#4caf50";
          imagesUploaded = true; // Mark as uploaded
        } else {
          alert("Error: " + data.error);
          btn.innerText = "Retry Upload";
          btn.classList.add("active");
          btn.disabled = false;
        }

      } catch (e) {
        alert("System error during upload");
        console.error(e);
        btn.innerText = "Retry Upload";
        btn.classList.add("active");
        btn.disabled = false;
      }
    };

    // Initial check (in case user reloads page, though basic count is 0)
    checkFinalButton();

    /* Submit */
    document.getElementById("submitBtn").onclick = async () => {
      let propertyTypeVal = document.getElementById("propertyType").value.trim();
      let whatYouSawVal = document.getElementById("whatYouSaw").value.trim();

      /* âœ… Fully merged comments from 8 fields + main field */
      let commentsVal = "\n\nFamily Background: " + document.getElementById("c_family").value.trim() +
        "\n\nHousehold Verification: " + document.getElementById("c_household").value.trim() +
        "\n\nFinancial Observation: " + document.getElementById("c_financial").value.trim() +
        "\n\nLoan / EMI Details: " + document.getElementById("c_loan").value.trim() +
        "\n\nEducation Loan: " + document.getElementById("c_edu_loan").value.trim() +
        "\n\nStudent Attitude / Behavior: " + document.getElementById("c_attitude").value.trim() +
        "\n\nOther Observations: " + document.getElementById("c_observation").value.trim() +
        "\n\nBackup Plan: " + document.getElementById("c_backup").value.trim();

      let recommendationVal = document.getElementById("volunteerRecommendation").value;

      // Required fields validation
      if (!propertyTypeVal || !whatYouSawVal || recommendationVal.includes("Select")) {
        alert("Please fill required fields (Property, What You Saw, Recommendation)");
        return;
      }

      // Check if images are selected
      if (selectedFiles.length < MIN_IMAGES) {
        alert(`âš ï¸ Please select at least ${MIN_IMAGES} house image(s) before submitting.`);
        return;
      }

      // Check if quality was checked
      if (!qualityChecked) {
        alert("âš ï¸ Please click 'Check Quality' button first to verify your images.");
        return;
      }

      // Check if we have enough accepted images
      if (acceptedImages.length < MIN_IMAGES) {
        alert(`âš ï¸ Only ${acceptedImages.length} image(s) passed quality check. Please add more images and check quality again.`);
        return;
      }

      let btn = document.getElementById("submitBtn");
      btn.innerText = "Processing...";
      btn.disabled = true;

      try {
        // Step 1: Upload accepted images (if not already uploaded)
        if (!imagesUploaded) {
          btn.innerText = "Uploading images...";

          const uploadFormData = new FormData();
          uploadFormData.append("studentId", "{{ studentId }}");

          acceptedImages.forEach(img => {
            uploadFormData.append("images", img.file);
          });

          const uploadRes = await fetch("/final-upload-batch", {
            method: "POST",
            body: uploadFormData
          });

          const uploadData = await uploadRes.json();

          if (!uploadData.success) {
            alert("Error uploading images: " + uploadData.error);
            btn.innerText = "Submit";
            btn.disabled = false;
            return;
          }

          imagesUploaded = true;
        }

        // Step 2: Submit PV form
        btn.innerText = "Submitting form...";

        let payload = {
          studentId: "{{ studentId }}",
          propertyType: propertyTypeVal,
          whatYouSaw: whatYouSawVal,
          comments: commentsVal || "",
          recommendation: recommendationVal,
          voiceAudio: audioBase64 || null
        };

        let res = await fetch("/submit-pv", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        let data = await res.json();

        if (data.success) {
          window.location.href = "/students-assign";
        } else {
          alert("Error submitting PV!");
          btn.innerText = "Submit";
          btn.disabled = false;
        }

      } catch (error) {
        console.error(error);
        alert("System error. Please try again.");
        btn.innerText = "Submit";
        btn.disabled = false;
      }
    };
  </script>
</body>

</html>